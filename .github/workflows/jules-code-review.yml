name: Jules AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  jules-review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Get repository source name
        id: get-source
        run: |
          SOURCE_ID="github/${{ github.repository_owner }}/${{ github.event.repository.name }}"
          echo "source_id=${SOURCE_ID}" >> $GITHUB_OUTPUT
          echo "source_name=sources/${SOURCE_ID}" >> $GITHUB_OUTPUT
      
      - name: Create Jules review session
        id: create-session
        run: |
          RESPONSE=$(curl -s 'https://jules.googleapis.com/v1alpha/sessions' \
            -X POST \
            -H "Content-Type: application/json" \
            -H "X-Goog-Api-Key: ${{ secrets.JULES_API_KEY }}" \
            -d '{
              "prompt": "Review the code changes in this PR by comparing the current branch (${{ github.head_ref }}) with the base branch (${{ github.base_ref }}).\\n\\nUse git diff to analyze ONLY the changes introduced in this PR.\\n\\nCheck for:\\n- Code quality and best practices\\n- Potential bugs or issues\\n- Performance concerns\\n- Security vulnerabilities\\n- TypeScript/Angular-specific issues\\n- Suggestions for improvement\\n\\nProvide a detailed review with specific feedback on the actual changes, not the entire codebase.",
              "sourceContext": {
                "source": "${{ steps.get-source.outputs.source_name }}",
                "githubRepoContext": {
                  "startingBranch": "${{ github.head_ref }}"
                }
              },
              "title": "Code Review for PR #${{ github.event.pull_request.number }}"
            }')
          
          echo "Response: $RESPONSE"
          SESSION_ID=$(echo $RESPONSE | jq -r '.id')
          echo "session_id=${SESSION_ID}" >> $GITHUB_OUTPUT
      
      - name: Post Jules review notification
        uses: actions/github-script@v7
        with:
          script: |
            const sessionId = '${{ steps.create-session.outputs.session_id }}';
            const sessionUrl = `https://jules.google/sessions/${sessionId}`;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ðŸ¤– Jules AI Code Review Started
              
              Jules is analyzing the code changes in this PR. This typically takes 10-15 minutes.
              
              **Session ID:** \`${sessionId}\`
              
              ðŸ“Š [Track progress in Jules Dashboard](${sessionUrl})
              
              Jules will automatically create a PR with fixes if issues are found, or you can view the full review in the dashboard.
              
              ---
              
              *Comparing: \`${{ github.base_ref }}\`...\`${{ github.head_ref }}\`*`
            });
