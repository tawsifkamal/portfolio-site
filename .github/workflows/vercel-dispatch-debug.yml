name: Vercel Dispatch Debug

on:
  repository_dispatch:
    types:
      - vercel.deployment.failed
      - vercel.deployment.error

permissions:
  checks: write
  contents: read

jobs:
  dump-event:
    runs-on: ubuntu-latest
    steps:
      - name: Print payload (debug)
        run: |
          echo "=== Vercel Deployment Failed ==="
          echo "Deployment ID: ${{ github.event.client_payload.id }}"
          echo "Deployment URL: ${{ github.event.client_payload.url }}"
          echo "Commit SHA: ${{ github.event.client_payload.git.sha }}"
          echo "Branch: ${{ github.event.client_payload.git.ref }}"
          echo ""
          echo "Full payload:"
          echo "${{ toJson(github.event.client_payload) }}"
      
      - name: Fetch Vercel deployment logs
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          DEPLOYMENT_ID: ${{ github.event.client_payload.id }}
        run: |
          echo "Fetching Vercel deployment logs..."
          if [ -z "$VERCEL_TOKEN" ]; then
            echo "âš ï¸  VERCEL_TOKEN secret not set - cannot fetch logs"
            echo "To get logs, add VERCEL_TOKEN to repo secrets:"
            echo "  1. Create token: https://vercel.com/account/tokens"
            echo "  2. Add to GitHub: Settings â†’ Secrets â†’ Actions â†’ New secret"
            exit 0
          fi
          
          # Fetch deployment details from Vercel API
          curl -s "https://api.vercel.com/v13/deployments/$DEPLOYMENT_ID" \
            -H "Authorization: Bearer $VERCEL_TOKEN" | jq .
      
      - name: Find PR and comment
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.payload.client_payload.git.sha;
            const deploymentUrl = context.payload.client_payload.url;
            const errorMessage = context.payload.client_payload.state?.detail || 'Unknown error';
            
            // Find PRs associated with this commit
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: sha
            });
            
            if (prs.data.length > 0) {
              const pr = prs.data[0];
              
              // Post a comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `ðŸ¤– **Jules AI here!**\n\n` +
                  `I noticed the Vercel deployment failed with: \`${errorMessage}\`\n\n` +
                  `I'm already on itâ€”analyzing the error and working on a fix. I'll push a commit shortly! ðŸ”§\n\n` +
                  `[View deployment logs](${deploymentUrl})`
              });
              
              console.log(`Posted comment on PR #${pr.number}`);
            }
      
      - name: Invoke Jules to fix deployment error
        uses: google-labs-code/jules-action@v1.0.0
        with:
          prompt: |
            The Vercel deployment just failed with the following error:
            
            **Error:** ${{ github.event.client_payload.state.detail }}
            **Deployment URL:** ${{ github.event.client_payload.url }}
            **Commit SHA:** ${{ github.event.client_payload.git.sha }}
            **Branch:** ${{ github.event.client_payload.git.ref }}
            
            Please:
            1. Analyze the deployment failure
            2. Identify the root cause from the Vercel error
            3. Implement a fix
            4. Create a commit with the fix
            5. Ensure the fix will pass Vercel's build process
          jules_api_key: ${{ secrets.JULES_API_KEY }}
          starting_branch: ${{ github.event.client_payload.git.ref }}
          include_last_commit: true
      
      - name: Create check run on PR
        uses: actions/github-script@v7
        with:
          script: |
            // Get the commit SHA from Vercel's payload (CORRECT path: git.sha not github.sha)
            const sha = context.payload.client_payload.git.sha;
            const deploymentUrl = context.payload.client_payload.url;
            
            console.log(`Creating check run for commit ${sha}`);
            
            // Create a check run on that commit
            const checkRun = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Vercel Deployment Status',
              head_sha: sha,
              status: 'completed',
              conclusion: 'failure',
              output: {
                title: 'Vercel deployment failed',
                summary: `Vercel deployment failed for this commit.\n\n` +
                  `**Deployment URL:** ${deploymentUrl}\n` +
                  `**SHA:** ${sha}\n\n` +
                  `View full logs at: ${deploymentUrl}`
              }
            });
            
            console.log(`Check run created: ${checkRun.data.html_url}`);
